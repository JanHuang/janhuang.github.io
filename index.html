<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="// 黄总">
<meta property="og:url" content="http://janhuang.github.io/index.html">
<meta property="og:site_name" content="// 黄总">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="// 黄总">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '5381324',
      author: '黄总大大'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://janhuang.github.io/"/>





  <title> // 黄总 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">// 黄总</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://janhuang.github.io/2017/08/10/gateway/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄总">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="// 黄总">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/10/gateway/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-10T15:42:45+08:00">
                2017-08-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/10/gateway/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/10/gateway/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="FastD-最佳实践之-构建API网关"><a href="#FastD-最佳实践之-构建API网关" class="headerlink" title="FastD 最佳实践之: 构建API网关"></a>FastD 最佳实践之: 构建API网关</h1><p>构建完成 API 服务，配置中心之后，架构图大致如下:</p>
<p><img src="http://fastdlabs.com/storage/QQ20170810-120757%402x.png" alt=""></p>
<h4 id="我们为何需要网关"><a href="#我们为何需要网关" class="headerlink" title="我们为何需要网关"></a>我们为何需要网关</h4><p>引用 <a href="https://mp.weixin.qq.com/s/XTzRr0eR6ybpNFGJ57cVkA" target="_blank" rel="external">别人</a> 的一句话:</p>
<blockquote>
<p>我们总是听到编排这个词，所以我喜欢这张幻灯片 – 它展示了一个乐队，然后有个指挥家，下面一堆人（微型服务）演奏自己的乐器。这个指挥家（API网关）可以以某种方式来协调我们的架构如何处理请求。</p>
</blockquote>
<p>我们需要将业务或服务放置在网关背后，由网关统一处理请求入口，本身由多个入口的处理变成了一个入口，由网关进行统一调度。</p>
<blockquote>
<p>有一个很nice的事情，就是API网关让我们的客户端不用再需要知道和关心模块的地址（address）了。网关负责来搞这些事情，你只需要知道网关就好了。你可以去改变实现而且还可以改变API接口。不过通常来说，你改变接口后，会增加客户端出问题的风险。</p>
</blockquote>
<p>还有很多有趣的功能，有兴趣的朋友可以参考:</p>
<ol>
<li><a href="https://mp.weixin.qq.com/s/XTzRr0eR6ybpNFGJ57cVkA" target="_blank" rel="external">微服务与API 网关（上）: 为什么需要API网关？</a></li>
<li><a href="https://mp.weixin.qq.com/s/Woktbld0-7bd73ySmVA3ug" target="_blank" rel="external">微服务与API 网关（下）: Kong能为我们做什么？</a></li>
</ol>
<h4 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h4><p>由于本人使用 ubuntu 虚拟机，所以此处只介绍 ubuntu 下的安装，其他安装方式可参考: <a href="https://getkong.org/install/" target="_blank" rel="external">kong installation</a></p>
<h5 id="安装-postgresql"><a href="#安装-postgresql" class="headerlink" title="安装 postgresql"></a>安装 postgresql</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo add-apt-repository &quot;deb http://apt.postgresql.org/pub/repos/apt/ xenial-pgdg main&quot;</div><div class="line">wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -</div><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install postgresql-9.6</div></pre></td></tr></table></figure>
<p>安装 postgresql 完成后，初始化数据库:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">su postgres</div><div class="line">psql</div><div class="line">CREATE USER kong; CREATE DATABASE kong OWNER kong;</div></pre></td></tr></table></figure>
<p><code>ctrl + D</code> 退出</p>
<h5 id="安装-kong"><a href="#安装-kong" class="headerlink" title="安装 kong"></a>安装 kong</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get update</div><div class="line">$ sudo apt-get install openssl libpcre3 procps perl</div><div class="line">$ sudo dpkg -i kong-0.10.3.*.deb</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ kong start</div><div class="line"></div><div class="line"># Kong is running</div><div class="line">$ curl 127.0.0.1:8001</div></pre></td></tr></table></figure>
<p>这个过程可能会出现: <code>[postgres error] FATAL: password authentication failed for user &quot;kong&quot;</code></p>
<p>查看 pgsql 配置文件所在位置，因为我是 <code>apt-get install</code> 的，因此，存储位置在 <code>/etc/postgresql/9.6/</code></p>
<p>修改 <code>/etc/postgresql/9.6/main/pg_hba.conf</code> 文件，找到IPv4 配置项，约92行，修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">host    all             all             127.0.0.1/32            md5</div><div class="line"></div><div class="line">=&gt;</div><div class="line"></div><div class="line">host    all             all             127.0.0.1/32            trust</div></pre></td></tr></table></figure>
<p>重新启动即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo kong start</div></pre></td></tr></table></figure>
<h4 id="整合-FastD-API"><a href="#整合-FastD-API" class="headerlink" title="整合 FastD API"></a>整合 FastD API</h4><h5 id="1-添加-API-到网关"><a href="#1-添加-API-到网关" class="headerlink" title="1. 添加 API 到网关"></a>1. 添加 API 到网关</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">curl -i -X POST \</div><div class="line">  http://127.0.0.1:8001/apis/ \</div><div class="line">  --data &apos;name=example-fastd&apos; \</div><div class="line">  --data &apos;hosts=fastd.com&apos; \</div><div class="line">  --data &apos;upstream_url=http://127.0.0.1:9527&apos;</div></pre></td></tr></table></figure>
<p>添加 API Server 到网关，成果会返回 201 状态吗表示创建成功 (Created)</p>
<h5 id="2-检查-API-状态"><a href="#2-检查-API-状态" class="headerlink" title="2. 检查 API 状态"></a>2. 检查 API 状态</h5><p>获取列表: <code>http://127.0.0.1:8001/apis/</code></p>
<p>发起请求.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl -i -X GET \</div><div class="line">  --url http://127.0.0.1:8000/ \</div><div class="line">  --header &apos;Host: fastd.com&apos;</div></pre></td></tr></table></figure>
<p>此时此刻你会发现已经成功使用 kong 对其进行代理，至此之外，已经完成了基本的网关接入。</p>
<p><img src="http://fastdlabs.com/storage/QQ20170815-174158%402x.png" alt=""></p>
<h4 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h4><p>kong 提供的插件非常丰富，因为也是基于 lua 的，因此你可以使用 openresty 对其进行扩展，开发更加贴近业务的应用。</p>
<p>插件文档: <a href="https://getkong.org/docs/0.10.x/admin-api/#plugin-object" target="_blank" rel="external">点击</a></p>
<p>更多可看 kong 官方文档。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://janhuang.github.io/2017/08/09/config_center/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄总">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="// 黄总">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/09/config_center/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-09T19:10:23+08:00">
                2017-08-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/09/config_center/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/09/config_center/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="FastD-最佳实践之-构建配置中心"><a href="#FastD-最佳实践之-构建配置中心" class="headerlink" title="FastD 最佳实践之: 构建配置中心"></a>FastD 最佳实践之: 构建配置中心</h1><p>过去专门做了一篇文档来构建配置中心，基于 <a href="https://zookeeper.apache.org/" target="_blank" rel="external">zookeeper</a> 的配置中心。</p>
<p>环境要求及构建步骤可参考: <a href="https://segmentfault.com/a/1190000008949515" target="_blank" rel="external">QConf搭建配置中心</a></p>
<p>随着业务增长，部署的机器可能会随着增长，增加配置难度和维护难度。配置会因为机器的增多而变得更加容易出错，为了解决这个问题，于是我们引入了 360 开发的 Qconf 来解决这个问题，目前已经稳定用于线上环境当中。</p>
<h4 id="安装-qconf-扩展包"><a href="#安装-qconf-扩展包" class="headerlink" title="安装 qconf 扩展包"></a>安装 qconf 扩展包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">composer require fastd/qconf-service-provider -vvv</div></pre></td></tr></table></figure>
<p>扩展包有点特殊，不需要任何的注册操作，当执行完 composer 依赖之后，会自动加载辅助函数，仅需对配置中心进行读取配置即可。</p>
<p>提供两个函数:</p>
<p><code>qconf_get_value</code> 获取对应节点值</p>
<p><code>qconf_get_values</code> 获取对应节点值数组</p>
<h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p><code>config/config.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> [</div><div class="line">    <span class="string">'demo'</span> =&gt; qconf_get_value(<span class="string">'/demo/test'</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="string">'abc'</span>)</div><div class="line">];</div></pre></td></tr></table></figure>
<p>值得注意的是，如果万一不小心，qconf 出现错误或者异常无法运行的时候，则需要保留一个默认配置项，这个小动作可能会在你系统出现异常的时候救你一命。</p>
<h4 id="测试配置中心"><a href="#测试配置中心" class="headerlink" title="测试配置中心"></a>测试配置中心</h4><p>完成基础配置后，需要对配置中心进行简单的测试。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php bin/console config:dump config</div></pre></td></tr></table></figure>
<p>结果会将配置文件进行输出，来确认是否可用。</p>
<p>最终架构图如下:</p>
<p>@import “<a href="http://fastdlabs.com/storage/QQ20170810-120757%402x.png" target="_blank" rel="external">http://fastdlabs.com/storage/QQ20170810-120757%402x.png</a>“</p>
<p>无论扩展多少个业务应用，仅需要一个配置中心即可完成处出修改。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://janhuang.github.io/2017/08/07/best_practice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄总">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="// 黄总">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/07/best_practice/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-07T18:55:02+08:00">
                2017-08-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/07/best_practice/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/07/best_practice/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="FastD-最佳实践之-构建API服务"><a href="#FastD-最佳实践之-构建API服务" class="headerlink" title="FastD 最佳实践之: 构建API服务"></a>FastD 最佳实践之: 构建API服务</h1><p>FastD 是一个专门针对 API 应用层而生的一个 PHP 应用框架，提供良好的中间件，路由以及支持 swoole 扩展运行，从而具体良好的性能条件。</p>
<h4 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">composer create-project fastd/dobee api -vvv</div></pre></td></tr></table></figure>
<p>创建一个为 API 的项目。</p>
<h4 id="运行第一个程序"><a href="#运行第一个程序" class="headerlink" title="运行第一个程序"></a>运行第一个程序</h4><p>进入命令行模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php -S localhost:9876 -t web</div></pre></td></tr></table></figure>
<p>访问 <code>localhost:9876</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"msg"</span>:<span class="string">"hello dobee"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h4><p>点击: <a href="http://fastdlabs.com/blog/2" target="_blank" rel="external">FastD设计详解</a></p>
<h4 id="实现第一个路由"><a href="#实现第一个路由" class="headerlink" title="实现第一个路由"></a>实现第一个路由</h4><h5 id="1-创建”控制器”"><a href="#1-创建”控制器”" class="headerlink" title="1. 创建”控制器”"></a>1. 创建”控制器”</h5><p>通过命令行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php bin/console controller:create &#123;name&#125;</div></pre></td></tr></table></figure>
<p>命令行会自动创建 CURD 多个操作方法，由开发者手动添加操作逻辑。</p>
<p>手动创建</p>
<p>MeController.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Controller</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">FastD</span>\<span class="title">Http</span>\<span class="title">ServerRequest</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MeController</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">me</span><span class="params">(ServerRequest $request)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> json([</div><div class="line">            <span class="string">'name'</span> =&gt; <span class="string">'janhuang'</span></div><div class="line">        ]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="2-添加路由地址"><a href="#2-添加路由地址" class="headerlink" title="2. 添加路由地址"></a>2. 添加路由地址</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line">route()-&gt;get(<span class="string">'/'</span>, <span class="string">'WelcomeController@welcome'</span>);</div><div class="line">route()-&gt;get(<span class="string">'/hello/&#123;name&#125;'</span>, <span class="string">'WelcomeController@sayHello'</span>);</div><div class="line">route()-&gt;get(<span class="string">'/who'</span>, <span class="string">'MeController@me'</span>);</div></pre></td></tr></table></figure>
<h5 id="3-调用"><a href="#3-调用" class="headerlink" title="3. 调用"></a>3. 调用</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i http://127.0.0.1:9876/who</div></pre></td></tr></table></figure>
<blockquote>
<p>response</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"janhuang"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完成最第一个路由。</p>
<h4 id="给应用添加单元测试"><a href="#给应用添加单元测试" class="headerlink" title="给应用添加单元测试"></a>给应用添加单元测试</h4><p>我仍热认为测试是一个非常重要的环节，也是一个优秀开发者一个重要品质之一。</p>
<p>如果其中涉及数据库测试，可以参考: <a href="https://github.com/JanHuang/fastD/blob/master/docs/zh_CN/3-6-testcase.md#数据库测试" target="_blank" rel="external">数据库测试</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Testing</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">FastD</span>\<span class="title">TestCase</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WelcomeControllerTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testSayHello</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        $request = <span class="keyword">$this</span>-&gt;request(<span class="string">'GET'</span>, <span class="string">'/'</span>);</div><div class="line">        $response = <span class="keyword">$this</span>-&gt;app-&gt;handleRequest($request);</div><div class="line">        <span class="keyword">$this</span>-&gt;isSuccessful($response);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以给你的应用API添加格式各样的测试，来验证程序的有效性。</p>
<h4 id="给-API-添加公共缓存"><a href="#给-API-添加公共缓存" class="headerlink" title="给 API 添加公共缓存"></a>给 API 添加公共缓存</h4><p><strong>何为公共缓存？</strong></p>
<p>公共缓存的灵感来自于 <a href="https://varnish-cache.org/" target="_blank" rel="external">varnish</a>，当用户发起非 <code>GET</code> 请求的时候，进行缓存处理并返回(如果有的话)，其他请求一律穿透，交给底层处理。</p>
<p>缓存也是一个前置中间件，使用方式与日常操作保持一致。</p>
<p>文档: <a href="https://github.com/JanHuang/fastD/blob/master/docs/zh_CN/3-2-middleware.md" target="_blank" rel="external">中间件</a></p>
<p><code>config/app.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> [</div><div class="line">    <span class="comment">// code...</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Http middleware</div><div class="line">     */</div><div class="line">    <span class="string">'middleware'</span> =&gt; [</div><div class="line">        <span class="comment">// code</span></div><div class="line">        <span class="string">'common.cache'</span> =&gt; [\FastD\Middleware\CacheMiddleware::class]</div><div class="line">    ],</div><div class="line">];</div></pre></td></tr></table></figure>
<p><code>config/routes.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line">route()-&gt;get(<span class="string">'/'</span>, <span class="string">'WelcomeController@welcome'</span>);</div><div class="line">route()-&gt;get(<span class="string">'/hello/&#123;name&#125;'</span>, <span class="string">'WelcomeController@sayHello'</span>);</div><div class="line">route()-&gt;get(<span class="string">'/who'</span>, <span class="string">'MeController@me'</span>)-&gt;withMiddleware(<span class="string">'common.cache'</span>);</div></pre></td></tr></table></figure>
<p>完成配置后，请求路由地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">curl -i http://localhost:9876/who</div><div class="line"></div><div class="line">HTTP/1.1 200</div><div class="line">Host: localhost:9876</div><div class="line">Connection: close</div><div class="line">X-Powered-By: PHP/7.0.0</div><div class="line">Content-Type: application/json; charset=UTF-8</div><div class="line">X-Cache: ee4d94f352cb03116b61ce9158720ebf</div><div class="line">Expires: Tue, 08 Aug 2017 10:58:21 GMT</div></pre></td></tr></table></figure>
<p>会产生 <code>X-Cache</code> 新的响应头，用于代表缓存生效。</p>
<h4 id="Basic-Auth"><a href="#Basic-Auth" class="headerlink" title="Basic Auth"></a>Basic Auth</h4><p>大部分 API 中，都需要对请求来源进行一定的鉴权处理，由于框架已经集成了简单的 Basic auth，使用方法与上述保持一致。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line">route()-&gt;get(<span class="string">'/'</span>, <span class="string">'WelcomeController@welcome'</span>);</div><div class="line">route()-&gt;get(<span class="string">'/hello/&#123;name&#125;'</span>, <span class="string">'WelcomeController@sayHello'</span>);</div><div class="line">route()-&gt;get(<span class="string">'/who'</span>, <span class="string">'MeController@me'</span>)-&gt;withMiddleware([<span class="string">'basic.auth'</span>, <span class="string">'common.cache'</span>]);</div></pre></td></tr></table></figure>
<h4 id="为-API-Server-加速"><a href="#为-API-Server-加速" class="headerlink" title="为 API Server 加速"></a>为 API Server 加速</h4><p>众所周知，<a href="http://swoole.com/" target="_blank" rel="external">swoole</a> 为 PHP 提供了良好的性能体验和网络通信体验，而框架中也无缝整合 swoole，为框架、服务提供良好体验做了一个铺垫，现在，你只需要配置IP、端口、swoole常用配置，即可无痕启动以 swoole 服务器，为你的 API Server 进行加速处理。</p>
<p><code>config/server.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span>    jan huang &lt;bboyjanhuang<span class="doctag">@gmail</span>.com&gt;</div><div class="line"> * <span class="doctag">@copyright</span> 2016</div><div class="line"> *</div><div class="line"> * <span class="doctag">@link</span>      https://www.github.com/janhuang</div><div class="line"> * <span class="doctag">@link</span>      http://www.fast-d.cn/</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">return</span> [</div><div class="line">    <span class="string">'host'</span> =&gt; <span class="string">'http://'</span>.get_local_ip().<span class="string">':9527'</span>,</div><div class="line">    <span class="string">'class'</span> =&gt; \FastD\Servitization\Server\HTTPServer::class,</div><div class="line">    <span class="string">'options'</span> =&gt; [</div><div class="line">        <span class="string">'user'</span> =&gt; <span class="string">'nobody'</span>,</div><div class="line">        <span class="string">'group'</span> =&gt; <span class="string">'nogroup'</span>,</div><div class="line">        <span class="string">'pid_file'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../runtime/pid/'</span> . app()-&gt;getName() . <span class="string">'.pid'</span>,</div><div class="line">        <span class="string">'log_file'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../runtime/logs/'</span> . app()-&gt;getName() . <span class="string">'.pid'</span>,</div><div class="line">        <span class="string">'log_level'</span> =&gt; <span class="number">5</span>,</div><div class="line">        <span class="string">'worker_num'</span> =&gt; <span class="number">10</span>,</div><div class="line">        <span class="string">'task_worker_num'</span> =&gt; <span class="number">20</span>,</div><div class="line">    ],</div><div class="line">    <span class="string">'processes'</span> =&gt; [</div><div class="line"></div><div class="line">    ],</div><div class="line">    <span class="string">'listeners'</span> =&gt; [</div><div class="line"></div><div class="line">    ],</div><div class="line">];</div></pre></td></tr></table></figure>
<p><code>get_local_ip</code> 函数为了默认或者本地内网ip，如果你的API是对外开放的，请修改为您的外网ip或者 <code>0.0.0.0</code>。</p>
<p><code>options</code> 参数为 swoole 扩展配置参数。请参考: <a href="https://wiki.swoole.com/wiki/page/274.html" target="_blank" rel="external">swoole配置</a></p>
<h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php bin/server start</div></pre></td></tr></table></figure>
<h5 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a>守护进程</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php bin/server start -d</div></pre></td></tr></table></figure>
<h5 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php bin/server stop</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://janhuang.github.io/2017/04/17/fastd-3-1-released/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄总">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="// 黄总">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/17/fastd-3-1-released/" itemprop="url">
                  fastd-3.1-released
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-17T12:07:22+08:00">
                2017-04-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/17/fastd-3-1-released/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/17/fastd-3-1-released/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>自 3.0 发布以来，FastD 终于确定了发展的路线，最终还是和 <a href="http://www.swoole.com/" target="_blank" rel="external">Swoole</a> 走在了一起，并且基于 Swoole 提供强大的性能支持。项目地址: <a href="https://github.com/JanHuang/fastD" target="_blank" rel="external">FastD</a></p>
<h4 id="优势"><a href="#优势" class="headerlink" title="优势:"></a>优势:</h4><ol>
<li>简单，灵活，开发服务与开发 Web 一样简单</li>
<li>同时支持 HTTP、TCP、UDP、WebSocket 等服务器</li>
<li>麻雀虽小，五脏俱全</li>
<li>专注底层 API 开发</li>
</ol>
<p>FastD 已经在很多场景已经使用，特别针对后端 RESTful API上，已经构建不少的内部服务，后续会陆续开源一些中小型的解决方案，用于发现问题和解决问题。</p>
<h3 id="理念-化繁为简"><a href="#理念-化繁为简" class="headerlink" title="理念: 化繁为简"></a>理念: 化繁为简</h3><p>FastD 的理念是: 提供一个主干，让开发者灵活拆卸零件(ServiceProvider)，让项目，功能更加独立和灵活。不同于 Symfony、Laravel，FastD 仅提供最基础的核心主干，其他均由开发者自助组装</p>
<p>框架不会过度整合太多不必要的组件，现在不会，未来也不会。并且框架定位于后端 API 开发中，不会整合模板，如果有必要的话，可以自己组装一个模板扩展或者提供器进行整合。</p>
<p>如果你的团队正打算分离 API 和前端，不妨尝试一下。</p>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">+--------------+         +-------------------+                           </div><div class="line">|              |         |                   |                           </div><div class="line">|    client    |--------&gt;|  new application  |                           </div><div class="line">|              |         |                   |                           </div><div class="line">+--------------+         +-------------------+                           </div><div class="line">        ^                          |                                     </div><div class="line">        |                          |                                     </div><div class="line">        |                          |                                     </div><div class="line">        |                          v                                     </div><div class="line">        |                +-------------------+                           </div><div class="line">        |                |                   |                           </div><div class="line">        |                |     bootstrap     |                           </div><div class="line">        |                |                   |                           </div><div class="line">        |                +-------------------+                           </div><div class="line">        |                          |                                     </div><div class="line">        |                          |                                     </div><div class="line">        |                          v                                     </div><div class="line">        |                +------------------+                            </div><div class="line">        |                |                  |                            </div><div class="line">        |                | service provider |                            </div><div class="line">        |                |                  |                            </div><div class="line">        |                +------------------+                            </div><div class="line">        |                          |                                     </div><div class="line">        |                          v                                     </div><div class="line">        |                +------------------+        +------------------+</div><div class="line">        |                |                  |        |                  |</div><div class="line">        |                |  handle request  |-------&gt;|  route dispatch  |</div><div class="line">        |                |                  |        |                  |</div><div class="line">        |                +------------------+        +------------------+</div><div class="line">        |                          |                           |         </div><div class="line">        |                   +------+------+                    |         </div><div class="line">        |                   |  exception  |                    |         </div><div class="line">        |                   +------+------+                    |         </div><div class="line">        |                          |                           |         </div><div class="line">        |                          v                           v         </div><div class="line">        |                +------------------+         +-----------------+</div><div class="line">        |                |                  |         |                 |</div><div class="line">        |                | handle exception |         | call middleware |</div><div class="line">        |                |                  |         |                 |</div><div class="line">        |                +------------------+         +-----------------+</div><div class="line">        |                          |                           |         </div><div class="line">        |                          |                           |         </div><div class="line">        |                          v                           |         </div><div class="line">        |                +------------------+                  |         </div><div class="line">        |                |                  |                  |         </div><div class="line">        +----------------| handle response  |&lt;-----------------+         </div><div class="line">                         |                  |                            </div><div class="line">                         +------------------+</div></pre></td></tr></table></figure>
<h3 id="贡献"><a href="#贡献" class="headerlink" title="贡献"></a>贡献</h3><p>非常感谢一下两位小伙伴，提供宝贵的意见和PR，希望未来会有更多感兴趣的朋友参与其中。</p>
<ul>
<li><a href="https://github.com/yyz26371945" target="_blank" rel="external">yyz26371945</a></li>
<li><a href="https://github.com/RunnerLee" target="_blank" rel="external">RunnerLee</a></li>
</ul>
<p>非常欢迎感兴趣，愿意参与其中，共同打造更好PHP生态，Swoole生态的开发者。</p>
<p>如果你乐于此，却又不知如何开始，可以试试下面这些事情：</p>
<ul>
<li>在你的系统中使用，将遇到的问题 <a href="https://github.com/JanHuang/fastD/issues" target="_blank" rel="external">反馈</a>。</li>
<li>有更好的建议？欢迎联系 <a href="mailto:bboyjanhuang@gmail.com" target="_blank" rel="external">bboyjanhuang@gmail.com</a> 或 <a href="http://weibo.com/ecbboyjan" target="_blank" rel="external">新浪微博:编码侠</a>。</li>
</ul>
<h3 id="简单上手"><a href="#简单上手" class="headerlink" title="简单上手"></a>简单上手</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ pecl install swoole</div><div class="line">$ composer create-project --stability=rc fastd/dobee</div></pre></td></tr></table></figure>
<h5 id="启动-Web-框架"><a href="#启动-Web-框架" class="headerlink" title="启动 Web 框架"></a>启动 Web 框架</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ php -S localhost:9876 -t web</div></pre></td></tr></table></figure>
<h5 id="访问-Web"><a href="#访问-Web" class="headerlink" title="访问 Web"></a>访问 Web</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ curl -i http://localhost:9876/</div></pre></td></tr></table></figure>
<p>更多操作及文档请访问: <a href="https://github.com/JanHuang/fastD/blob/master/docs/zh_CN/readme.md" target="_blank" rel="external">FastD</a></p>
<h3 id="反馈-amp-帮助"><a href="#反馈-amp-帮助" class="headerlink" title="反馈&amp;帮助"></a>反馈&amp;帮助</h3><p>如果你在使用中遇到问题，请联系: <a href="mailto:bboyjanhuang@gmail.com" target="_blank" rel="external">bboyjanhuang@gmail.com</a>. 微博: <a href="http://weibo.com/ecbboyjan" target="_blank" rel="external">编码侠</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://janhuang.github.io/2017/04/08/ci/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄总">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="// 黄总">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/08/ci/" itemprop="url">
                  ci
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-08T09:40:41+08:00">
                2017-04-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/08/ci/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/08/ci/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一节讲到了 PHP 单元测试，数据库测试，那么测试报告结果怎么添加到自己的 github 项目中去呢?也或者说，怎么让程序自动帮我们完成这些工作呢?</p>
<p>我就简单带大家入门一下吧。估计很多朋友们对着方面其实没啥要求的，不过了解一下，搞不好以后用得着。</p>
<p>相关网站: </p>
<ul>
<li><a href="https://travis-ci.org/" target="_blank" rel="external">TravisCI</a></li>
<li><a href="https://styleci.io/" target="_blank" rel="external">StyleCI</a></li>
<li><a href="https://scrutinizer-ci.com/" target="_blank" rel="external">ScrutinizerCI</a></li>
</ul>
<h3 id="TravisCI"><a href="#TravisCI" class="headerlink" title="TravisCI"></a>TravisCI</h3><p>进去 <a href="https://travis-ci.org/" target="_blank" rel="external">TravisCi</a> ，授权登录，Sign in for github，选择账号</p>
<p><img src="https://segmentfault.com/img/bVLUca" alt="图片描述"></p>
<p>开发需要做集成的项目。</p>
<p><img src="https://segmentfault.com/img/bVLUcc" alt="图片描述"></p>
<p>添加 <code>.travis.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attr">language:</span> <span class="string">php</span></div><div class="line"><span class="attr">php:</span></div><div class="line"><span class="bullet">-</span> <span class="string">'5.6'</span></div><div class="line"><span class="bullet">-</span> <span class="string">'7'</span></div><div class="line"></div><div class="line"><span class="attr">script:</span> <span class="string">vendor/bin/phpunit</span></div></pre></td></tr></table></figure>
<p><img src="https://segmentfault.com/img/bVLUcd" alt="图片描述"></p>
<p>根据具体测试反馈，对代码进行修正，更新，重复以上步骤，以保证代码的健壮性。</p>
<p>每次当我们推送代码，就会触发 travis ci，由程序自动帮我们执行如配置文件中的流程，其中除了 <code>script</code> 选项外，还有其他，例如: <code>before_script</code>, <code>after_script</code>，等选项，更多选项和配置请参考: <a href="https://docs.travis-ci.com/user/customizing-the-build/" target="_blank" rel="external">TravisCI文档</a>。</p>
<p>如果需要用到其他测试套件，例如 redis，mysql 等，则需要配置 services 配置项，mysql 默认账号: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">username: root</div><div class="line">password:</div></pre></td></tr></table></figure>
<p>具体可以参考: <a href="https://docs.travis-ci.com/user/database-setup/" target="_blank" rel="external">Setting up Services and Database</a></p>
<h3 id="StyleCI"><a href="#StyleCI" class="headerlink" title="StyleCI"></a>StyleCI</h3><p>为了保持与 StyleCI 的编码风格一致，我们需要设置 PHPStorm IDE 的编码规范。</p>
<p><img src="https://segmentfault.com/img/bVLUcm" alt="图片描述"></p>
<p>设置完编码规范后，通过快捷键: option + command + l 一键格式化(针对 Mac 操作)。</p>
<p>进入 <a href="https://styleci.io/" target="_blank" rel="external">styleci.io</a>, 使用 github 账号登录，进入账号，选择 Repos, 选择需要进行测试的项目。</p>
<p><img src="https://segmentfault.com/img/bVLUco" alt="图片描述"></p>
<p>测试完成后，系统会产生测试报告，并且可以自动发送 PR 请求到 github，帮助你一键修复代码。</p>
<p>可以添加如下配置信息到配置文件: <code>.styleci.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="attr">preset:</span> <span class="string">symfony</span></div><div class="line"></div><div class="line"><span class="attr">linting:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="attr">enabled:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">strict</span></div><div class="line"><span class="bullet">  -</span> <span class="string">strict_param</span></div><div class="line"><span class="bullet">  -</span> <span class="string">ordered_use</span></div></pre></td></tr></table></figure>
<p>在代码提交的时候，自动执行以上规范检查。然后找到 badge 添加到 reamde.md 文件中即可显示项目构建状态。更多配置项请参考文档: <a href="https://styleci.readme.io/docs/getting-started" target="_blank" rel="external">StyleCi文档</a></p>
<p>StyleCI 是这么多个系统中，相对操作简单的一个质量检测系统。</p>
<h3 id="Scrutinizer-CI"><a href="#Scrutinizer-CI" class="headerlink" title="Scrutinizer CI"></a>Scrutinizer CI</h3><p>顾名思义，他是一个执行质量检查的工具，用于规范代码和提前暴露一些代码问题。</p>
<p>同样的，需要授权登录在平台当中，也是使用 github 进行登录。</p>
<p><img src="https://segmentfault.com/img/bVLUct" alt="图片描述"></p>
<p>添加对应需要执行的 Repository，添加完成后，可以对项目进行第一次质量检查，得出初步的信息。</p>
<p><img src="https://segmentfault.com/img/bVLUcD" alt="图片描述"></p>
<p>执行完成，生成报告后，可以添加测试结果图标到项目中。但如果项目上没有具体配置信息，可以在此处</p>
<p><img src="https://segmentfault.com/img/bVLUct" alt="图片描述"></p>
<p>获取配置信息，添加到 <code>.scrutinizer.yml</code> 文件中，那么在下次执行检查的时候，就会按照指定的工作流去指定代码检查。</p>
<p>如果在质量检查的时候用到 <code>dbunit</code> 测试套件的，scrutinizer 提供相当多的套件，可以对应配置具体测试数据。</p>
<p>数据库默认账号: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">username: root</div><div class="line">password:</div></pre></td></tr></table></figure>
<p>如果想要执行创建库，创建表，可以在配置项 <code>build</code> 中，添加配置信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attr">build:</span></div><div class="line"><span class="attr">    project_setup:</span></div><div class="line"><span class="attr">            before:</span></div><div class="line"><span class="bullet">                -</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-e</span> <span class="string">"CREATE DATABASE IF NOT EXISTS demo;"</span></div></pre></td></tr></table></figure>
<p>更多配置请参考: <a href="https://scrutinizer-ci.com/docs/configuration/build" target="_blank" rel="external">Build Configuration</a></p>
<p>如果不清楚配置文件如何配置，可以参考 github 上的开源项目，找到 .travis.yml, 等隐藏文件即可，又或者可以看我的项目: <a href="https://github.com/JanHuang/fastD" target="_blank" rel="external">fastD</a></p>
<p>暂且说这么多先把。还有很多很多的功能和测试就靠大家去发掘了。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://janhuang.github.io/2017/04/07/php/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄总">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="// 黄总">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/07/php/" itemprop="url">
                  php
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-07T15:37:31+08:00">
                2017-04-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/07/php/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/07/php/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>趁着吃下午茶，我也来简单谈谈对 PHP 甚至 PHPer 的一些看法。</p>
<p>况且”最好的语言”要是没有”优秀的人”，那几本就是扯淡，没错，就是你们在大大小小的群经常看到的，扯淡。</p>
<p>语言之争，框架之争，估计也多多少少，有一些历史了吧。我是有点不太懂或者说不太了解这些争论的目的是啥，每天总有人很热衷于去争论这些所谓的”最好”，鸟哥不想理你们并且向你们抛出了异常。</p>
<p>不过也不好喷你们吧，我又不是什么喷子，多一事不如少一事，我就当没看到。</p>
<p>适合就好。</p>
<p>争论完这些，其实纵观一下当前技术圈子，互联网圈子，满屏都是大数据，vuejs，react，人工智能，虽然我不是这种瞎鸡毛崇拜技术的人，但是多多少少，会觉得有一些害怕，害怕哪天，自己被淘汰了，却浑然不知。</p>
<p>话说在1，2年前，composer 还是个很新潮的东西，PSR 还是个刚成雏形的规范，swoole 也还没那么火的时候，会觉得，懂这些东西，真尼玛高大上。然而放眼现在，其实这些东西，感觉像是入门级别的要求了。</p>
<p>这能说明什么?说明，整体门槛相对以前，高了，也意味着，你如果不懂这些东西，可能你已经落后了，成为边缘化的一份子。这其实还不是最严重的，更严重的是，其他语言已经雄起，你确定 PHP 还能”单独”支撑多少年?</p>
<p>要不是 PHP7，Swoole 在这两年相对能 hold 得住一些，不然 PHP 的世界确实会有停滞。试想想，是不是每天都还在 CURD? 给你写上个 5 年 10 年，能有啥长进? 醒醒吧，大清亡了。</p>
<p>更有甚者，眼光相对狭隘的开发者，只会关心自己当前，并不会去投资自己的未来，也就是我经常遇到的(真是Fucking The Dog)。PHP 不仅要去快速构建应用，实现功能，还需要考虑，是否需要其他工具来帮助你去实现，去完成所需的功能，不要只停留在 PHP 层面。</p>
<p>除了以上之争，还有很多盲目崇拜的人，他们自负，他们高傲，好像整个世界，就他会一样(其实我有好几句妈卖批不知道该不该讲)，盲目推崇各种技术。我个人可以很大胆地觉得，凡是脱离业务，纯粹的技术炫耀，并没有什么乱用。</p>
<p>我个人也是对 PHP 相对熟悉一些，所以很多的开发都是基于 PHP。但是，我不会去瞎鸡毛吹 PHP 有多厉害，去喷这个架构有多烂，这些代码跟屎一样(当然，还真的有屎一样的代码)。</p>
<p>我也不会去盲目崇拜去追随一些所谓的开发牛人，前沿的技术，但我会去学习，但我不会盲目，我很庆幸，我还能保持一定的理智。工具的东西，毕竟看谁用，每个人用都不一样。人的东西，能学到就是好事，不能学到也不能怨别人，毕竟学习都是靠自己的。</p>
<p>对于一些新技术的尝试，我觉得，只要是在自己的掌控范围之内，都可以去尝试使用，有的朋友就担心不稳定，我觉得吧，应该会比起你写的业务代码 bug 要少一些。一定要敢于去尝试自己觉得感兴趣的技术或者知识。</p>
<p>如果 PHP 不能满足我的功能需求的时候，我会考虑是否有一些开源的系统可以快速帮助我去完成这个功能，当然最后会找到很多解决方案。可以善用你的 github。</p>
<p>是否才发现，PHP 并不是一切，还有很多你尚未探索的世界，那你事情放下对某些事情的盲目执着，去扩展，提升自己的综合能力? 是否身边还有很多抱怨着，天天写鸡毛业务代码，却还是一无所成的人? 那你就要警惕，他分分钟坑你一把。</p>
<p>说说我自己吧，不可否认，在工作中，我确实是个打杂，说好的架构呢，说好的管理呢，说好的技术支持呢，shit，到头来，还是东忙西忙，一无所事。幸好我燃烧的心还没熄灭，在我业余的时间，创造了我第三个框架(前两个废了，垃圾。): <a href="https://github.com/JanHuang/fastD" target="_blank" rel="external">FastD</a>。</p>
<p>机会吧，应该是自己创造或者说去发现的。你以为躺着赚钱容易吗? 你也得投资啊(3秒后，身体哆嗦一下，开启圣贤模式)。没有那么多人真的是天天瞎逼逼就能盘满钵满的，搞不好人家经历的比你还多。</p>
<p>当我们选择坚持做好一些事情的时候，就需要适当放弃一些执念，就是这么一个过程让我从 0 - 1 走了过来(虽然还鸡毛在打杂吧，但已经是高级打杂了)，我觉得我，还是坚持我想要的，我知道我需要什么。</p>
<p>感觉时间过得很快，我已经是个 4 年的老司机了，虽比预期慢了一年，但还算充实，接下来，时间就自己分配，做好工作，做好自己。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://janhuang.github.io/2017/03/26/qconf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄总">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="// 黄总">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/26/qconf/" itemprop="url">
                  qconf
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-26T12:08:39+08:00">
                2017-03-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/26/qconf/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/26/qconf/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天来跟大家分享的是奇虎360开源的 <a href="https://github.com/Qihoo360/QConf" target="_blank" rel="external">QConf</a> 配置中心。</p>
<p>为什么我们需要做这么一件事情?</p>
<p>因为遇到了，当业务分布较广，配置分布较广的时候，就会很容易地出现一些问题，比如做了负载均衡，需要调整一下应用配置。刚好改漏了一台机，就偶尔出现一些问题，排查起来也是很吃力的。</p>
<p>QConf 的架构: <a href="https://github.com/Qihoo360/QConf/wiki/QConf-%E6%9E%B6%E6%9E%84" target="_blank" rel="external">QConf架构</a></p>
<p>除了 QConf 本身提供的工具之外，我们用到了一个有掌阅科技开发的 <a href="https://github.com/ireaderlab/zkdash" target="_blank" rel="external">zkdash</a> zookeeper 管理工具。</p>
<p>个人理解: </p>
<p>QConf 可以说是一个 zookeeper 的客户端，通过 agent 去 watch zookeeper 的变化，数据存在本机，当 zookeeper 发生变化是，自动改变本地数据，来达到同步更新的效果。</p>
<p><img src="http://www.uml.org.cn/pzgl/images/201612073.jpg" alt="结构"></p>
<p>这也就是为什么 QConf 需要搭配 zookeeper 去使用的原因之一吧。</p>
<h3 id="QConf-服务端"><a href="#QConf-服务端" class="headerlink" title="QConf 服务端"></a>QConf 服务端</h3><p>QConf使用ZooKeeper集群作为服务端提供服务。众所周知，ZooKeeper是一套分布式应用程序协调服务，根据上面提到的对配置内容的定位，我们认为可以将单条配置内容直接存储在ZooKeeper的一个ZNode上，并利用ZooKeeper的Watch监听功能实现配置变化时对客户端的及时通知。 按照ZooKeeper的设计目标，其只提供最基础的功能，包括顺序一致，原子性，单一系统镜像，可靠性和及时性。</p>
<p>我们选择Zookeeper还因为它有如下特点：</p>
<p>1、类文件系统的节点组织</p>
<p>2、稳定，无单点问题</p>
<p>3、订阅通知机制</p>
<p>关于Zookeeper，更多见：<a href="https://zookeeper.apache.org/" target="_blank" rel="external">https://zookeeper.apache.org/</a></p>
<h3 id="QConf-客户端"><a href="#QConf-客户端" class="headerlink" title="QConf 客户端"></a>QConf 客户端</h3><p>因为ZooKeeper在接口方面只提供了非常基本的操作，并且其客户端接口原始，所以我们需要在QConf的客户端部分解决如下问题：</p>
<p>1、降低与ZooKeeper的链接数 原生的ZooKeeper客户端中，所有需要获取配置的进程都需要与ZooKeeper保持长连接，在生产环境中每个客户端机器可能都会有上百个进程需要访问数据，这对ZooKeeper的压力非常大而且也是不必要的。</p>
<p>2、本地缓存 当然我们不希望客户端进程每次需要数据都走网络获取，所以需要维护一份客户端缓存，仅在配置变化时更新。</p>
<p>3、容错 当进程死掉，网络终端，机器重启等异常情况发生时，我们希望能尽可能的提供可靠的配置获取服务。</p>
<p>4、多语言版本接口 目前提供的语言版本包括：c，php，java，python，go，lua，shell。</p>
<p>5、配置更新及时 可以秒级同步到所有客户端机器。</p>
<p>6、高效的配置读取 内存级的访问速度。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>了解完基础的知识和原理，就开始动手实践想法和操作吧，理论要和实践结合，不然就瞎扯淡了。</p>
<h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><p>Linux: Ubuntu 16.04</p>
<h4 id="安装-zookeeper"><a href="#安装-zookeeper" class="headerlink" title="安装 zookeeper"></a>安装 zookeeper</h4><p>安装包地址: <a href="http://zookeeper.apache.org/releases.html" target="_blank" rel="external">zookeeper</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo wget http://apache.stu.edu.tw/zookeeper/zookeeper-3.4.9/zookeeper-3.4.9.tar.gz</div><div class="line">$ sudo tar -zxvf zookeeper-3.4.9.tar.gz</div></pre></td></tr></table></figure>
<p>解压完成后，是可以直接运行 zkServer 的，但是需要配置自己的基础信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cd zookeeper-3.4.9</div><div class="line">$ sudo cp conf/zoo_sample.cfg conf/zoo.cfg</div></pre></td></tr></table></figure>
<p>启动 zkServer </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cd ../</div><div class="line">$ ./bin/zkServer.sh start</div></pre></td></tr></table></figure>
<p>默认监听: <code>0.0.0.0:2181</code></p>
<p>测试服务是否启动: <code>telnet 127.0.0.1 2181</code> 输入 <code>stat</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Zookeeper version: 3.4.9-1757313, built on 08/23/2016 06:50 GMT</div><div class="line">Clients:</div><div class="line">  xxx</div><div class="line"></div><div class="line">Latency min/avg/max: 0/0/51</div><div class="line">Received: 252717</div><div class="line">Sent: 252716</div><div class="line">Connections: 5</div><div class="line">Outstanding: 0</div><div class="line">Zxid: 0x13</div><div class="line">Mode: standalone</div><div class="line">Node count: 10</div></pre></td></tr></table></figure>
<p>会输出上述信息，服务器启动成功.</p>
<p>然后创建一下 zookeeper 测试数据: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sh zkCli.sh</div><div class="line"></div><div class="line">    create /demo demo</div><div class="line">    create /demo/confs confs</div><div class="line">    create /demo/confs/conf1 111111111111111111111</div><div class="line">    create /demo/confs/conf2 222222222222222222222</div><div class="line">    create /demo/confs/conf3 333333333333333333333</div></pre></td></tr></table></figure>
<h4 id="QConf"><a href="#QConf" class="headerlink" title="QConf"></a>QConf</h4><p>安装方式可以查看官方 <a href="https://github.com/Qihoo360/QConf/wiki/QConf-%E7%AE%80%E6%98%93%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BD%BF%E7%94%A8" target="_blank" rel="external">wiki</a></p>
<p>安装 <a href="https://github.com/Qihoo360/QConf/wiki/FAQ" target="_blank" rel="external">FAQ</a></p>
<p>安装完 qconf 后，进入 qconf 安装目录，调整 idc.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cd conf/</div><div class="line">$ sudo vim idc.conf</div></pre></td></tr></table></figure>
<p>输入自己的 zookeeper 服务器地址，多个用 <code>,</code> 隔开: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#[zookeeper]</div><div class="line">############################################################################</div><div class="line">#                             QCONF config                                 #</div><div class="line">############################################################################</div><div class="line"># all the zookeeper host configuration.</div><div class="line">#[zookeeper]</div><div class="line">zookeeper.test=zookeeper host</div></pre></td></tr></table></figure>
<p>保存即可。</p>
<p>启动 QConf agent。</p>
<blockquote>
<p>在 ubuntu 下使用 bash 去启动</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo bash ./bin/agent-cmd.sh start</div></pre></td></tr></table></figure>
<p>启动成功，查看 QConf 命令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">qconf get_conf /demo/confs/conf1</div><div class="line">qconf get_batch_keys /demo/confs</div></pre></td></tr></table></figure>
<p>如果返回对应的信息，那几说明可以正常获取数据了。如果失败，就去 logs/ 目录查询错误信息，对应修改。</p>
<h5 id="安装-PHP-扩展"><a href="#安装-PHP-扩展" class="headerlink" title="安装 PHP 扩展"></a>安装 PHP 扩展</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/usr/local/php/bin/phpize</div><div class="line">./configure --with-php-config=/usr/local/php/bin/php-config --with-libqconf-dir=/usr/local/qconf/include --enable-static LDFLAGS=/usr/local/qconf/lib/libqconf.a</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>
<p>qconf 配置在 qconf 安装的目录中，根据路径找到对应的依赖包即可。</p>
<p>安装完后，添加到 php.ini，使用 <code>php --ini</code> 查看配置文件位置。</p>
<p>查看扩展安装: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php -m | grep qconf</div></pre></td></tr></table></figure>
<p><a href="https://github.com/Qihoo360/QConf/wiki/QConf-PHP-Doc" target="_blank" rel="external">QConf 操作 API</a></p>
<p>安装完 QConf 和 zookeeper，安装我们的管理后台。</p>
<h4 id="zkdash"><a href="#zkdash" class="headerlink" title="zkdash"></a>zkdash</h4><blockquote>
<p>需要 Python &gt;= 2.7，如果是 centos65 的用户，需要升级自己的 Python 版本，升级方法请看: <a href="http://ruter.sundaystart.net/2015/12/03/Update-python/" target="_blank" rel="external">Python升级</a></p>
</blockquote>
<p>地址: <a href="https://github.com/ireaderlab/zkdash" target="_blank" rel="external">zkdash</a></p>
<p>安装完 zkdash，配置对应节点，进行管理即可。</p>
<blockquote>
<p>zkdash Web管理服务默认是全网公开访问的，需要修改监听host和端口，修改方式</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo vim init.py</div></pre></td></tr></table></figure>
<p>修改监听的 host 地址: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">74 def main():</div><div class="line">75     &quot;&quot;&quot;主程序入口</div><div class="line">76     &quot;&quot;&quot;</div><div class="line">77     logger.init_logger(LOG_ITEMS, suffix=OPTIONS.port)</div><div class="line">78     application = Application()</div><div class="line">79     http_server = tornado.httpserver.HTTPServer(application,</div><div class="line">80                                                 xheaders=True)</div><div class="line">81     http_server.listen(OPTIONS.port, address=&quot;输入你需要监听的地址&quot;) </div><div class="line">82     tornado.ioloop.IOLoop.instance().start()</div><div class="line">83</div></pre></td></tr></table></figure>
<p>address 是新增的 host 参数。本身是没有的</p>
<p>恭喜你，你已经构建完自己的配置中心了。接下来需要做的是，提高性能，和稳定性，扩展 zookeeper。我只能帮你到这里了，接下来的路，自己走吧。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://janhuang.github.io/2017/03/20/testing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄总">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="// 黄总">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/20/testing/" itemprop="url">
                  testing
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-20T23:45:57+08:00">
                2017-03-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/20/testing/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/20/testing/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我总感觉 PHP 的开发者们并没有对 PHP 的质量有所追求，可能是因为 PHP 的机制问题吧，让大部分的开发者总以为浏览器访问就没有问题，所以很多时候，做 PHP 开发的，就没有单元测试的这些概念了。</p>
<p>我个人也是 PHP，但同时我也比较讨厌那些完事就算了的开发者，作为一个开发者，或者说是一个产品的经手人，就应该用心地去做好每个细节，一次比一次要更好。</p>
<p>但是做单元测试，质量检查，是需要一定的时间和人力投入的，但我敢保证地说，你花时间投入的，绝对不会是没用的，一定对你，对项目来说，是一个质的提升，只要你肯投入时间用心去做。</p>
<p>屁话说太多了，那接下来简单讲讲 phpunit 吧，<a href="https://phpunit.de/manual/current/zh_cn/installation.html" target="_blank" rel="external">官网</a>。</p>
<p>因为我们习惯用 <code>composer</code>，所以我们也使用 <code>composer</code> 安装吧。</p>
<h3 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ composer <span class="keyword">require</span> phpunit/phpunit -vvv</div></pre></td></tr></table></figure>
<p>安装完 phpunit，bin 执行脚本会创建在 <code>vendor/bin</code> 目录下，命名为 <code>phpunit</code>, 执行 <code>php vendor/bin/phpunit</code> 执行测试脚本</p>
<p><code>phpunit</code> 可以配置在当前执行路径添加一个配置文件 <code>phpunit.xml.dist</code> 或者 <code>phpunit.xml</code>，内容如下: </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">phpunit</span></span></div><div class="line">         <span class="attr">colors</span>=<span class="string">"true"</span></div><div class="line">         <span class="attr">bootstrap</span>=<span class="string">"./vendor/autoload.php"</span></div><div class="line">        &gt;</div><div class="line">    <span class="tag">&lt;<span class="name">testsuites</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">testsuite</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>dir1<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">testsuite</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">testsuite</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>dir2<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">testsuite</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">testsuites</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">phpunit</span>&gt;</span></div></pre></td></tr></table></figure>
<p>可以通过配置目录和初始化信息，让脚本自动执行对应的测试用例。</p>
<h3 id="基础使用"><a href="#基础使用" class="headerlink" title="基础使用"></a>基础使用</h3><p>使用 PHPUnit 创建我们的测试用例: </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoTest</span> <span class="keyword">extends</span> <span class="title">PHPUnit_Framework_TestCase</span></span></div><div class="line">&#123;</div><div class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testPushAndPop</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            $stack = [];</div><div class="line">            <span class="keyword">$this</span>-&gt;assertEquals(<span class="number">0</span>, count($stack));</div><div class="line">    </div><div class="line">            array_push($stack, <span class="string">'foo'</span>);</div><div class="line">            <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foo'</span>, $stack[count($stack)<span class="number">-1</span>]);</div><div class="line">            <span class="keyword">$this</span>-&gt;assertEquals(<span class="number">1</span>, count($stack));</div><div class="line">    </div><div class="line">            <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foo'</span>, array_pop($stack));</div><div class="line">            <span class="keyword">$this</span>-&gt;assertEquals(<span class="number">0</span>, count($stack));</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>类名需要以 *Test 结尾，继承 <code>PHPUnit_Framework_TestCase</code>。需要测试的方法需要一 test 开头，表明是一个测试方法。</p>
<p>一般常用测试无非就是 “断言”，说白了，就是看看产生的结果是不是符合预期，如果是，那就证明，已经测试通过，否则，失败，说明逻辑处理，存在一定的差异，导致不符合预期。</p>
<p>更多的测试使用方法请看官网用例: <a href="https://phpunit.de/manual/current/zh_cn/" target="_blank" rel="external">PHPUnit</a></p>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>当我们的测试对象继承了 PHPUnit 后，初始化方法就需要使用它本身提供的 setUp 方法，代表类初始化，可以在初始化方法中初始化一些资源，或者加载。</p>
<h3 id="数据库测试"><a href="#数据库测试" class="headerlink" title="数据库测试"></a>数据库测试</h3><p>除了以上基础的测试之外，关键一点应该在动态的数据，需要去测试吗，如果需要，那应该怎么去测试? 生产环境，也需要这样测试? 这个曾经困惑这我的问题，已经解开。</p>
<p>解答: </p>
<ol>
<li>composer 中，有 –no-dev 选项，用来部署生产环境，避免测试环境的数据或者代码跑在了生产环境下。并且生产环境上数据库操作是没有很高权限的操作，要是有的话，你得回去面壁思考一下了。</li>
<li>dbunit 每次测试都重置数据，其实在生产环境下，就重置不了了，第一个是composer –no-dev 已经没有执行权利了，要是有，数据库已经不允许清空操作了。</li>
<li>要是生产环境不需要这些东西，那么应该怎么测试。其实需要有一个模拟生产环境的测试环境，去模拟生产环境测试，当所有测试都OK没有问题，那么就可以发布到生产环境上，要是严格一些，生产环境也是需要一轮测试。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ composer require phpunit/dbunit -vvv</div></pre></td></tr></table></figure>
<p>更多测试可看: <a href="https://phpunit.de/manual/current/zh_cn/database.html" target="_blank" rel="external">数据库测试</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DBTest</span> <span class="keyword">extends</span> <span class="title">PHPUnit_Extensions_Database_TestCase</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@return</span> PHPUnit_Extensions_Database_DB_IDatabaseConnection</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getConnection</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        $pdo = <span class="keyword">new</span> PDO(<span class="string">'mysql::dbname=test;host=127.0.0.1'</span>, <span class="string">'user'</span>, <span class="string">'pass'</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;createDefaultDBConnection($pdo, <span class="string">':memory:'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@return</span> \PHPUnit_Extensions_Database_DataSet_AbstractDataSet</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDataSet</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">// Yml</span></div><div class="line">        <span class="comment">// return new \PHPUnit_Extensions_Database_DataSet_YamlDataSet(&#123;yaml.file&#125;);</span></div><div class="line">        <span class="comment">// xml</span></div><div class="line">        <span class="comment">// return new \PHPUnit_Extensions_Database_DataSet_XmlDataSet(&#123;xml.file&#125;);</span></div><div class="line">        <span class="comment">// php array</span></div><div class="line">        <span class="comment">// return new \PHPUnit_Extensions_Database_DataSet_ArrayDataSet([]);</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>getConnection</code> 方法是获取数据库连接，继承数据库测试后，必须实现的一个方法，并且需要返回 <code>PHPUnit_Extensions_Database_DB_IDatabaseConnection</code> 对象，可以仿照上述写法即可。</p>
<p><code>getDataSet</code> 方法是数据集，在创建数据库测试的时候，自动填充，测试，和删除。他执行的流程是，每个测试用例，都会填充一次，以保证不会被其他测试用例影响。当当前测试用例测试完成后，会 <code>truncate</code> 掉填充的数据。</p>
<p>数据集支持挺多种方法，可以自定义数组，yml，xml，可以根据自己的使用习惯，自定义填充数据。数据集可看: <a href="https://phpunit.de/manual/current/zh_cn/database.html#database.understanding-datasets-and-datatables" target="_blank" rel="external">点我</a></p>
<p>执行脚本 <code>php vendor/bin/phpunit</code></p>
<p>然后去对应查看自己的数据表，是否多了一些填充的数据呢? 只要我们有了初始化的数据，对接下来数据库测试，就跟平时的断言测试没有什么两样了。</p>
<h4 id="抽象自己的数据库测试类"><a href="#抽象自己的数据库测试类" class="headerlink" title="抽象自己的数据库测试类"></a>抽象自己的数据库测试类</h4><p>在很多情况下，我们的业务可谓是各种各样吧，倘若 phpunit 提供的数据库测试还不能满足或者不够方便的时候，就需要扩展自己的数据库测试，来达到自己想要的效果。</p>
<p>幸好，phpunit 提供了灵活的扩展操作(肯定啦，别人肯定不会像你这么傻，写死吧。哈哈)，我们可以很容易地去实现自己的数据库测试类。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApp_Tests_DatabaseTestCase</span> <span class="keyword">extends</span> <span class="title">PHPUnit_Extensions_Database_TestCase</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 只实例化 pdo 一次，供测试的清理和装载基境使用</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">private</span> $pdo = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 对于每个测试，只实例化 PHPUnit_Extensions_Database_DB_IDatabaseConnection 一次</span></div><div class="line">    <span class="keyword">private</span> $conn = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getConnection</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;conn === <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>::$pdo == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">self</span>::$pdo = <span class="keyword">new</span> PDO(<span class="string">'mysql::dbname=test;host=127.0.0.1'</span>, <span class="string">'user'</span>, <span class="string">'pass'</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">$this</span>-&gt;conn = <span class="keyword">$this</span>-&gt;createDefaultDBConnection(<span class="keyword">self</span>::$pdo, <span class="string">':memory:'</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;conn;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至今为止，完成了最基础和入门的单元测试和数据库测试，最终数据库无非就是查看数据增删改查是否和预期一样。所以，配置完数据库测试后，就可以走回第一步，编写你的测试用例，断言测试了。</p>
<p>恭喜你，你已经构建完自己的单元测试环境了。接下来需要做的是，提高易用性，测试覆盖率。我只能帮你到这里了，接下来的路，自己走吧。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://janhuang.github.io/2017/03/18/restful/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄总">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="// 黄总">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/18/restful/" itemprop="url">
                  restful
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-18T22:25:29+08:00">
                2017-03-18
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/18/restful/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/18/restful/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>大家都在讨论如何设计 RESTful API，我也来谈谈我对API设计的一些想法。</p>
<p>迄今为止，我个人认为，API设计较为好的是 github，可以去看看 github 的设计，<a href="https://developer.github.com/" target="_blank" rel="external">点击这里</a>。</p>
<p>我个人认为，想要设计好一个好看，易理解的API，首先得自己理解，而最基本的，应该是 url 的意义了吧，我相信，很多人都不完全知道 url 到底是啥，代表什么，仅仅是知道，是一个访问地址而已。</p>
<p>wiki 原文: <a href="https://zh.wikipedia.org/wiki/%E7%BB%9F%E4%B8%80%E8%B5%84%E6%BA%90%E5%AE%9A%E4%BD%8D%E7%AC%A6" target="_blank" rel="external">wiki</a> </p>
<blockquote>
<p>统一资源定位符（或称统一资源定位器/定位地址、URL地址等[1]，英语：Uniform / Universal Resource Locator，常缩写为URL），有时也被俗称为网页地址（网址）。如同在网络上的门牌，是因特网上标准的资源的地址（Address）。它最初是由蒂姆·伯纳斯-李发明用来作为万维网的地址。现在它已经被万维网联盟编制为因特网标准RFC 1738。<br>  在因特网的历史上，统一资源定位符的发明是一个非常基础的步骤。统一资源定位符的语法是一般的，可扩展的，它使用ASCII代码的一部分来表示因特网的地址。统一资源定位符的开始，一般会标志着一个计算机网络所使用的网络协议。</p>
</blockquote>
<p>那么设计一个较为优秀的 RESTful API 应该具备些什么条件呢? 下面我来说说我的想法。</p>
<h2 id="版本号"><a href="#版本号" class="headerlink" title="版本号"></a>版本号</h2><p>我相信大部分的开发者在做 APP API 的时候都有遇到过版本升级的时候，试想想，倘若没有一个合理的版本控制，那将是一个很痛苦的过程，先保证数据结构不变，兼容旧版本，还要升级当前结构，符合新版本结构，如此类推，数据结构将会越来越混乱。</p>
<p>举个例子: </p>
<p>v1: <code>https://example.com/user/1</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"nickname"</span>: <span class="string">"foo"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>v2: <code>https://examples.com/user/1</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"nickname"</span>: <span class="string">"foo"</span>,</div><div class="line">  <span class="attr">"age"</span>: <span class="string">"18"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如此类推，结构将会变得不可控。</p>
<p>合适的版本控制</p>
<p>v1: <code>https://example.com/v1/user/1</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"nickname"</span>: <span class="string">"foo"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>v2: <code>https://example.com/v2/user/1</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"nickname"</span>: <span class="string">"foo"</span>,</div><div class="line">  <span class="attr">"age"</span>: <span class="string">"18"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以很清晰地知道，两个已经不是同一个资源地址，因为两者之间是可以进行隔离，而不会相互影响。</p>
<h2 id="面向资源"><a href="#面向资源" class="headerlink" title="面向资源"></a>面向资源</h2><p>一开始我们谈到了 URL 的含义，其实面向资源正是 URL 最终的目的。试想想，我们 URL 不就是为了去公开一个具体可访问的资源吗? 网页，图片，视频，不就是一个个具体的内容吗?</p>
<p>还是举个例子吧: 比如我们做一个文章资源的访问 API。</p>
<p>列表: <code>https://example.com/posts</code><br>列表: <code>https://example.com/posts?page=1&amp;limit=10</code><br>详情: <code>https://example.com/posts/1</code></p>
<p>将域名忽略，path 看成是一个目录地址，那么结构将会变成: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">/posts</div><div class="line">    /1</div><div class="line">    /2</div><div class="line">    /3</div><div class="line">    /4</div><div class="line">    /5</div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>那么我们再访问 <code>/posts</code> 的时候，就是列出当前限定数量的文章列表，当查询参数 <code>page=2</code> 的时候，就是列出限定数量的第二个文章列表，而当我们想要访问具体文章的时候，就相当于打开目录，再点击具体文章，查看详情，那么，路径就会变成 <code>/posts/1</code> 这个一个形式。</p>
<p>然后在对比我们操作系统中的目录结构，是不是非常类似，那么结论已经有了，API 设计，就把它看成我们本地目录操作的形式一样，表达一个具体的资源地址，也是符合 URL 的含义，或许这就是 URL 本身的初衷吧。</p>
<p>而且我们可以在查询的时候添加灵活的查询条件(终于知道为什么?只有那串东西叫query string了)。比如: </p>
<p><code>https://example.com/posts?page=2&amp;limit=20</code> </p>
<p>如此类推，看具体功能实现如何，灵活搭配使用。</p>
<h2 id="合适的动作，也就是合适的-Method"><a href="#合适的动作，也就是合适的-Method" class="headerlink" title="合适的动作，也就是合适的 Method"></a>合适的动作，也就是合适的 Method</h2><p>刚才提到了访问文章列表，那么我们添加文章的时候，或者想象成添加文件的时候，也就是我们在操作系统上右键鼠标，新建文件(资源)的操作。</p>
<p>在我们的 HTTP 设计中，已经包含了具体的语意操作了，可以拿来即用，非常容易实现: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">HEAD	只获取某个资源的头部信息。比如只想了解某个文件的大小，某个资源的修改日期等</div><div class="line">GET	    获取资源</div><div class="line">POST	创建资源</div><div class="line">PATCH	更新资源的部分属性。因为 PATCH 比较新，而且规范比较复杂，所以真正实现的比较少，一般都是用 POST 替代</div><div class="line">PUT	    替换资源，客户端需要提供新建资源的所有属性。如果新内容为空，要设置 Content-Length 为 0，以区别错误信息</div><div class="line">DELETE	删除资源</div></pre></td></tr></table></figure>
<p>如果你是想是想 TCP 的 API，也或许 TCP 中并没有所谓的 RESTful，但是可以去语义化具体的操作。</p>
<p>不过是 HTTP，TCP，我们最终的目的就是，清晰一个操作的作用，也就是语义化具体操作。</p>
<h2 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h2><p>状态，自己看表吧: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">100	客户端应当继续发送请求。这个临时响应是用来通知客户端它的部分请求已经被服务器接收，且仍未被拒绝。客户端应当继续发送请求的剩余部分，或者如果请求已经完成，忽略这个响应。服务器必须在请求完成后向客户端发送一个最终响应。</div><div class="line">101	服务器已经理解了客户端的请求，并将通过Upgrade 消息头通知客户端采用不同的协议来完成这个请求。在发送完这个响应最后的空行后，服务器将会切换到在Upgrade 消息头中定义的那些协议。 　　只有在切换新的协议更有好处的时候才应该采取类似措施。例如，切换到新的HTTP 版本比旧版本更有优势，或者切换到一个实时且同步的协议以传送利用此类特性的资源。</div><div class="line">102	由WebDAV（RFC 2518）扩展的状态码，代表处理将被继续执行。</div><div class="line">200	请求已成功，请求所希望的响应头或数据体将随此响应返回。</div><div class="line">201	请求已经被实现，而且有一个新的资源已经依据请求的需要而建立，且其 URI 已经随Location 头信息返回。假如需要的资源无法及时建立的话，应当返回 &apos;202 Accepted&apos;。</div><div class="line">202	服务器已接受请求，但尚未处理。正如它可能被拒绝一样，最终该请求可能会也可能不会被执行。在异步操作的场合下，没有比发送这个状态码更方便的做法了。 　　返回202状态码的响应的目的是允许服务器接受其他过程的请求（例如某个每天只执行一次的基于批处理的操作），而不必让客户端一直保持与服务器的连接直到批处理操作全部完成。在接受请求处理并返回202状态码的响应应当在返回的实体中包含一些指示处理当前状态的信息，以及指向处理状态监视器或状态预测的指针，以便用户能够估计操作是否已经完成。</div><div class="line">203	服务器已成功处理了请求，但返回的实体头部元信息不是在原始服务器上有效的确定集合，而是来自本地或者第三方的拷贝。当前的信息可能是原始版本的子集或者超集。例如，包含资源的元数据可能导致原始服务器知道元信息的超级。使用此状态码不是必须的，而且只有在响应不使用此状态码便会返回200 OK的情况下才是合适的。</div><div class="line">204	服务器成功处理了请求，但不需要返回任何实体内容，并且希望返回更新了的元信息。响应可能通过实体头部的形式，返回新的或更新后的元信息。如果存在这些头部信息，则应当与所请求的变量相呼应。 　　如果客户端是浏览器的话，那么用户浏览器应保留发送了该请求的页面，而不产生任何文档视图上的变化，即使按照规范新的或更新后的元信息应当被应用到用户浏览器活动视图中的文档。 　　由于204响应被禁止包含任何消息体，因此它始终以消息头后的第一个空行结尾。</div><div class="line">205	服务器成功处理了请求，且没有返回任何内容。但是与204响应不同，返回此状态码的响应要求请求者重置文档视图。该响应主要是被用于接受用户输入后，立即重置表单，以便用户能够轻松地开始另一次输入。 　　与204响应一样，该响应也被禁止包含任何消息体，且以消息头后的第一个空行结束。</div><div class="line">206	服务器已经成功处理了部分 GET 请求。类似于 FlashGet 或者迅雷这类的 HTTP 下载工具都是使用此类响应实现断点续传或者将一个大文档分解为多个下载段同时下载。 　　该请求必须包含 Range 头信息来指示客户端希望得到的内容范围，并且可能包含 If-Range 来作为请求条件。 　　响应必须包含如下的头部域： 　　Content-Range 用以指示本次响应中返回的内容的范围；如果是 Content-Type 为 multipart/byteranges 的多段下载，则每一 multipart 段中都应包含 Content-Range 域用以指示本段的内容范围。假如响应中包含 Content-Length，那么它的数值必须匹配它返回的内容范围的真实字节数。 　　Date 　　ETag 和/或 Content-Location，假如同样的请求本应该返回200响应。 　　Expires, Cache-Control，和/或 Vary，假如其值可能与之前相同变量的其他响应对应的值不同的话。 　　假如本响应请求使用了 If-Range 强缓存验证，那么本次响应不应该包含其他实体头；假如本响应的请求使用了 If-Range 弱缓存验证，那么本次响应禁止包含其他实体头；这避免了缓存的实体内容和更新了的实体头信息之间的不一致。否则，本响应就应当包含所有本应该返回200响应中应当返回的所有实体头部域。 　　假如 ETag 或 Last-Modified 头部不能精确匹配的话，则客户端缓存应禁止将206响应返回的内容与之前任何缓存过的内容组合在一起。 　　任何不支持 Range 以及 Content-Range 头的缓存都禁止缓存206响应返回的内容。</div><div class="line">207	由WebDAV(RFC 2518)扩展的状态码，代表之后的消息体将是一个XML消息，并且可能依照之前子请求数量的不同，包含一系列独立的响应代码。</div><div class="line">300	被请求的资源有一系列可供选择的回馈信息，每个都有自己特定的地址和浏览器驱动的商议信息。用户或浏览器能够自行选择一个首选的地址进行重定向。 　　除非这是一个 HEAD 请求，否则该响应应当包括一个资源特性及地址的列表的实体，以便用户或浏览器从中选择最合适的重定向地址。这个实体的格式由 Content-Type 定义的格式所决定。浏览器可能根据响应的格式以及浏览器自身能力，自动作出最合适的选择。当然，RFC 2616规范并没有规定这样的自动选择该如何进行。 　　如果服务器本身已经有了首选的回馈选择，那么在 Location 中应当指明这个回馈的 URI；浏览器可能会将这个 Location 值作为自动重定向的地址。此外，除非额外指定，否则这个响应也是可缓存的。</div><div class="line">301	被请求的资源已永久移动到新位置，并且将来任何对此资源的引用都应该使用本响应返回的若干个 URI 之一。如果可能，拥有链接编辑功能的客户端应当自动把请求的地址修改为从服务器反馈回来的地址。除非额外指定，否则这个响应也是可缓存的。 　　新的永久性的 URI 应当在响应的 Location 域中返回。除非这是一个 HEAD 请求，否则响应的实体中应当包含指向新的 URI 的超链接及简短说明。 　　如果这不是一个 GET 或者 HEAD 请求，因此浏览器禁止自动进行重定向，除非得到用户的确认，因为请求的条件可能因此发生变化。 　　注意：对于某些使用 HTTP/1.0 协议的浏览器，当它们发送的 POST 请求得到了一个301响应的话，接下来的重定向请求将会变成 GET 方式。</div><div class="line">302	请求的资源现在临时从不同的 URI 响应请求。由于这样的重定向是临时的，客户端应当继续向原有地址发送以后的请求。只有在Cache-Control或Expires中进行了指定的情况下，这个响应才是可缓存的。 　　新的临时性的 URI 应当在响应的 Location 域中返回。除非这是一个 HEAD 请求，否则响应的实体中应当包含指向新的 URI 的超链接及简短说明。 　　如果这不是一个 GET 或者 HEAD 请求，那么浏览器禁止自动进行重定向，除非得到用户的确认，因为请求的条件可能因此发生变化。 　　注意：虽然RFC 1945和RFC 2068规范不允许客户端在重定向时改变请求的方法，但是很多现存的浏览器将302响应视作为303响应，并且使用 GET 方式访问在 Location 中规定的 URI，而无视原先请求的方法。状态码303和307被添加了进来，用以明确服务器期待客户端进行何种反应。</div><div class="line">303	对应当前请求的响应可以在另一个 URI 上被找到，而且客户端应当采用 GET 的方式访问那个资源。这个方法的存在主要是为了允许由脚本激活的POST请求输出重定向到一个新的资源。这个新的 URI 不是原始资源的替代引用。同时，303响应禁止被缓存。当然，第二个请求（重定向）可能被缓存。 　　新的 URI 应当在响应的 Location 域中返回。除非这是一个 HEAD 请求，否则响应的实体中应当包含指向新的 URI 的超链接及简短说明。 　　注意：许多 HTTP/1.1 版以前的 浏览器不能正确理解303状态。如果需要考虑与这些浏览器之间的互动，302状态码应该可以胜任，因为大多数的浏览器处理302响应时的方式恰恰就是上述规范要求客户端处理303响应时应当做的。</div><div class="line">304	如果客户端发送了一个带条件的 GET 请求且该请求已被允许，而文档的内容（自上次访问以来或者根据请求的条件）并没有改变，则服务器应当返回这个状态码。304响应禁止包含消息体，因此始终以消息头后的第一个空行结尾。 　　该响应必须包含以下的头信息： 　　Date，除非这个服务器没有时钟。假如没有时钟的服务器也遵守这些规则，那么代理服务器以及客户端可以自行将 Date 字段添加到接收到的响应头中去（正如RFC 2068中规定的一样），缓存机制将会正常工作。 　　ETag 和/或 Content-Location，假如同样的请求本应返回200响应。 　　Expires, Cache-Control，和/或Vary，假如其值可能与之前相同变量的其他响应对应的值不同的话。 　　假如本响应请求使用了强缓存验证，那么本次响应不应该包含其他实体头；否则（例如，某个带条件的 GET 请求使用了弱缓存验证），本次响应禁止包含其他实体头；这避免了缓存了的实体内容和更新了的实体头信息之间的不一致。 　　假如某个304响应指明了当前某个实体没有缓存，那么缓存系统必须忽视这个响应，并且重复发送不包含限制条件的请求。 　　假如接收到一个要求更新某个缓存条目的304响应，那么缓存系统必须更新整个条目以反映所有在响应中被更新的字段的值。</div><div class="line">305	被请求的资源必须通过指定的代理才能被访问。Location 域中将给出指定的代理所在的 URI 信息，接收者需要重复发送一个单独的请求，通过这个代理才能访问相应资源。只有原始服务器才能建立305响应。 　　注意：RFC 2068中没有明确305响应是为了重定向一个单独的请求，而且只能被原始服务器建立。忽视这些限制可能导致严重的安全后果。</div><div class="line">306	在最新版的规范中，306状态码已经不再被使用。</div><div class="line">307	请求的资源现在临时从不同的URI 响应请求。由于这样的重定向是临时的，客户端应当继续向原有地址发送以后的请求。只有在Cache-Control或Expires中进行了指定的情况下，这个响应才是可缓存的。 　　新的临时性的URI 应当在响应的 Location 域中返回。除非这是一个HEAD 请求，否则响应的实体中应当包含指向新的URI 的超链接及简短说明。因为部分浏览器不能识别307响应，因此需要添加上述必要信息以便用户能够理解并向新的 URI 发出访问请求。 　　如果这不是一个GET 或者 HEAD 请求，那么浏览器禁止自动进行重定向，除非得到用户的确认，因为请求的条件可能因此发生变化。</div><div class="line">400	1、语义有误，当前请求无法被服务器理解。除非进行修改，否则客户端不应该重复提交这个请求。 　　2、请求参数有误。</div><div class="line">401	当前请求需要用户验证。该响应必须包含一个适用于被请求资源的 WWW-Authenticate 信息头用以询问用户信息。客户端可以重复提交一个包含恰当的 Authorization 头信息的请求。如果当前请求已经包含了 Authorization 证书，那么401响应代表着服务器验证已经拒绝了那些证书。如果401响应包含了与前一个响应相同的身份验证询问，且浏览器已经至少尝试了一次验证，那么浏览器应当向用户展示响应中包含的实体信息，因为这个实体信息中可能包含了相关诊断信息。参见RFC 2617。</div><div class="line">402	该状态码是为了将来可能的需求而预留的。</div><div class="line">403	服务器已经理解请求，但是拒绝执行它。与401响应不同的是，身份验证并不能提供任何帮助，而且这个请求也不应该被重复提交。如果这不是一个 HEAD 请求，而且服务器希望能够讲清楚为何请求不能被执行，那么就应该在实体内描述拒绝的原因。当然服务器也可以返回一个404响应，假如它不希望让客户端获得任何信息。</div><div class="line">404	请求失败，请求所希望得到的资源未被在服务器上发现。没有信息能够告诉用户这个状况到底是暂时的还是永久的。假如服务器知道情况的话，应当使用410状态码来告知旧资源因为某些内部的配置机制问题，已经永久的不可用，而且没有任何可以跳转的地址。404这个状态码被广泛应用于当服务器不想揭示到底为何请求被拒绝或者没有其他适合的响应可用的情况下。</div><div class="line">405	请求行中指定的请求方法不能被用于请求相应的资源。该响应必须返回一个Allow 头信息用以表示出当前资源能够接受的请求方法的列表。 　　鉴于 PUT，DELETE 方法会对服务器上的资源进行写操作，因而绝大部分的网页服务器都不支持或者在默认配置下不允许上述请求方法，对于此类请求均会返回405错误。</div><div class="line">406	请求的资源的内容特性无法满足请求头中的条件，因而无法生成响应实体。 　　除非这是一个 HEAD 请求，否则该响应就应当返回一个包含可以让用户或者浏览器从中选择最合适的实体特性以及地址列表的实体。实体的格式由 Content-Type 头中定义的媒体类型决定。浏览器可以根据格式及自身能力自行作出最佳选择。但是，规范中并没有定义任何作出此类自动选择的标准。</div><div class="line">407	　与401响应类似，只不过客户端必须在代理服务器上进行身份验证。代理服务器必须返回一个 Proxy-Authenticate 用以进行身份询问。客户端可以返回一个 Proxy-Authorization 信息头用以验证。参见RFC 2617。</div><div class="line">408	请求超时。客户端没有在服务器预备等待的时间内完成一个请求的发送。客户端可以随时再次提交这一请求而无需进行任何更改。</div><div class="line">409	由于和被请求的资源的当前状态之间存在冲突，请求无法完成。这个代码只允许用在这样的情况下才能被使用：用户被认为能够解决冲突，并且会重新提交新的请求。该响应应当包含足够的信息以便用户发现冲突的源头。 　　冲突通常发生于对 PUT 请求的处理中。例如，在采用版本检查的环境下，某次 PUT 提交的对特定资源的修改请求所附带的版本信息与之前的某个（第三方）请求向冲突，那么此时服务器就应该返回一个409错误，告知用户请求无法完成。此时，响应实体中很可能会包含两个冲突版本之间的差异比较，以便用户重新提交归并以后的新版本。</div><div class="line">410	被请求的资源在服务器上已经不再可用，而且没有任何已知的转发地址。这样的状况应当被认为是永久性的。如果可能，拥有链接编辑功能的客户端应当在获得用户许可后删除所有指向这个地址的引用。如果服务器不知道或者无法确定这个状况是否是永久的，那么就应该使用404状态码。除非额外说明，否则这个响应是可缓存的。 　　410响应的目的主要是帮助网站管理员维护网站，通知用户该资源已经不再可用，并且服务器拥有者希望所有指向这个资源的远端连接也被删除。这类事件在限时、增值服务中很普遍。同样，410响应也被用于通知客户端在当前服务器站点上，原本属于某个个人的资源已经不再可用。当然，是否需要把所有永久不可用的资源标记为&apos;410 Gone&apos;，以及是否需要保持此标记多长时间，完全取决于服务器拥有者。</div><div class="line">411	服务器拒绝在没有定义 Content-Length 头的情况下接受请求。在添加了表明请求消息体长度的有效 Content-Length 头之后，客户端可以再次提交该请求。</div><div class="line">412	服务器在验证在请求的头字段中给出先决条件时，没能满足其中的一个或多个。这个状态码允许客户端在获取资源时在请求的元信息（请求头字段数据）中设置先决条件，以此避免该请求方法被应用到其希望的内容以外的资源上。</div><div class="line">413	服务器拒绝处理当前请求，因为该请求提交的实体数据大小超过了服务器愿意或者能够处理的范围。此种情况下，服务器可以关闭连接以免客户端继续发送此请求。 　　如果这个状况是临时的，服务器应当返回一个 Retry-After 的响应头，以告知客户端可以在多少时间以后重新尝试。</div><div class="line">414	请求的URI 长度超过了服务器能够解释的长度，因此服务器拒绝对该请求提供服务。这比较少见，通常的情况包括： 　　本应使用POST方法的表单提交变成了GET方法，导致查询字符串（Query String）过长。 　　重定向URI “黑洞”，例如每次重定向把旧的 URI 作为新的 URI 的一部分，导致在若干次重定向后 URI 超长。 　　客户端正在尝试利用某些服务器中存在的安全漏洞攻击服务器。这类服务器使用固定长度的缓冲读取或操作请求的 URI，当 GET 后的参数超过某个数值后，可能会产生缓冲区溢出，导致任意代码被执行[1]。没有此类漏洞的服务器，应当返回414状态码。</div><div class="line">415	对于当前请求的方法和所请求的资源，请求中提交的实体并不是服务器中所支持的格式，因此请求被拒绝。</div><div class="line">416	如果请求中包含了 Range 请求头，并且 Range 中指定的任何数据范围都与当前资源的可用范围不重合，同时请求中又没有定义 If-Range 请求头，那么服务器就应当返回416状态码。 　　假如 Range 使用的是字节范围，那么这种情况就是指请求指定的所有数据范围的首字节位置都超过了当前资源的长度。服务器也应当在返回416状态码的同时，包含一个 Content-Range 实体头，用以指明当前资源的长度。这个响应也被禁止使用 multipart/byteranges 作为其 Content-Type。</div><div class="line">417	在请求头 Expect 中指定的预期内容无法被服务器满足，或者这个服务器是一个代理服务器，它有明显的证据证明在当前路由的下一个节点上，Expect 的内容无法被满足。</div><div class="line">421	从当前客户端所在的IP地址到服务器的连接数超过了服务器许可的最大范围。通常，这里的IP地址指的是从服务器上看到的客户端地址（比如用户的网关或者代理服务器地址）。在这种情况下，连接数的计算可能涉及到不止一个终端用户。</div><div class="line">422	从当前客户端所在的IP地址到服务器的连接数超过了服务器许可的最大范围。通常，这里的IP地址指的是从服务器上看到的客户端地址（比如用户的网关或者代理服务器地址）。在这种情况下，连接数的计算可能涉及到不止一个终端用户。</div><div class="line">422	请求格式正确，但是由于含有语义错误，无法响应。（RFC 4918 WebDAV）423 Locked 　　当前资源被锁定。（RFC 4918 WebDAV）</div><div class="line">424	由于之前的某个请求发生的错误，导致当前请求失败，例如 PROPPATCH。（RFC 4918 WebDAV）</div><div class="line">425	在WebDav Advanced Collections 草案中定义，但是未出现在《WebDAV 顺序集协议》（RFC 3658）中。</div><div class="line">426	客户端应当切换到TLS/1.0。（RFC 2817）</div><div class="line">449	由微软扩展，代表请求应当在执行完适当的操作后进行重试。</div><div class="line">500	服务器遇到了一个未曾预料的状况，导致了它无法完成对请求的处理。一般来说，这个问题都会在服务器的程序码出错时出现。</div><div class="line">501	服务器不支持当前请求所需要的某个功能。当服务器无法识别请求的方法，并且无法支持其对任何资源的请求。</div><div class="line">502	作为网关或者代理工作的服务器尝试执行请求时，从上游服务器接收到无效的响应。</div><div class="line">503	由于临时的服务器维护或者过载，服务器当前无法处理请求。这个状况是临时的，并且将在一段时间以后恢复。如果能够预计延迟时间，那么响应中可以包含一个 Retry-After 头用以标明这个延迟时间。如果没有给出这个 Retry-After 信息，那么客户端应当以处理500响应的方式处理它。 　　注意：503状态码的存在并不意味着服务器在过载的时候必须使用它。某些服务器只不过是希望拒绝客户端的连接。</div><div class="line">504	作为网关或者代理工作的服务器尝试执行请求时，未能及时从上游服务器（URI标识出的服务器，例如HTTP、FTP、LDAP）或者辅助服务器（例如DNS）收到响应。 　　注意：某些代理服务器在DNS查询超时时会返回400或者500错误</div><div class="line">505	服务器不支持，或者拒绝支持在请求中使用的 HTTP 版本。这暗示着服务器不能或不愿使用与客户端相同的版本。响应中应当包含一个描述了为何版本不被支持以及服务器支持哪些协议的实体。</div><div class="line">506	由《透明内容协商协议》（RFC 2295）扩展，代表服务器存在内部配置错误：被请求的协商变元资源被配置为在透明内容协商中使用自己，因此在一个协商处理中不是一个合适的重点。</div><div class="line">507	服务器无法存储完成请求所必须的内容。这个状况被认为是临时的。WebDAV (RFC 4918)</div><div class="line">509	服务器达到带宽限制。这不是一个官方的状态码，但是仍被广泛使用。</div><div class="line">510	获取资源所需要的策略并没有没满足。（RFC 2774）</div></pre></td></tr></table></figure>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><p>不过在设计 API，或者做一些底层开发，框架开发的时候，良好的错误处理可以更好地提高质量，也从另外一方面提升体验和优化产品，也可见错误处理的重要性。</p>
<p>举个例子:  </p>
<p><code>HTTP 400 Bad Request</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"code"</span>: <span class="number">10086</span>,</div><div class="line">  <span class="attr">"msg"</span>: <span class="string">"您所拨打的电话已关闭"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>这里要注意的时候，错误码和状态码并不是同一回事，错误码是指具体错误内容的代码。</p>
</blockquote>
<p>以上错误的信息已经很明显了，但是有个问题，就是仅显示了对应的错误信息和错误码，并没有很好地引导客户去解决问题，因此我们可以提供更好的 <code>Hypermedia API</code>，也就是说，除了提示具体下一步操作，还可以具体提示到解决的方法，起一个很好的引导作用。</p>
<p>不过是在错误中，正确中，<code>Hypermedia API</code> 都是一个很好的引导入口。</p>
<p>如: </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"code"</span>: <span class="number">10086</span>,</div><div class="line">  <span class="attr">"msg"</span>: <span class="string">"您所拨打的电话已关闭"</span>,</div><div class="line">  <span class="attr">"documentation_url"</span>: <span class="string">"https://example.com/"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>形式不定，请尽情发挥。</p>
<h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p>除了以上的 <code>Hypermedia API</code> 和语义化设计，还需要提供良好可读的文档(这可谓是一个很高的调整，估计对大部分来说，比写论文还难吧)。</p>
<p>文档是很好地引导开发者去解决问题，并且，可以减少很多人工干预的工作，节省时间，提升自身迭代的效率。</p>
<p>这里非常值得注意的是，文档跟项目一样，都是需要不断迭代升级的，因此，这里有一定的工作量。</p>
<p>多说一句，文档一定要清晰。</p>
<h2 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h2><p>接口的安全性其实不容忽视，并且已经有很多的开源解决方案，可以更好地去参考和结合使用。</p>
<p>当然，这块是需要结合业务考虑的。</p>
<p>我们最常见的就是 Rate limit, Nginx，OpenResty 都有很好的模块支持。</p>
<p>如果对访问的次数不加控制，很可能会造成 API 被滥用。根据使用者不同的身份对其进行限流，可以有效缓解很多滥用和管理的问题。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://janhuang.github.io/2017/03/18/monitor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄总">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="// 黄总">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/18/monitor/" itemprop="url">
                  monitor
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-18T13:29:00+08:00">
                2017-03-18
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/18/monitor/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/18/monitor/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>相信大家很多人都用过redis，mysql等相关的服务，只需要客户端连接上去了，就可以执行对应的操作，比如: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">redis &gt; set foo bar</div><div class="line">redis &gt; get foo</div></pre></td></tr></table></figure>
<p>在框架 FastD 3.1 版本中，已经默认集成，只需要简单配置即可实现操作和管理。因为框架基于swoole，扩展开发，在默认的 fpm 模式下是不会有这种功能实现的，也不现实，更没有必要。</p>
<p>配置: </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> [</div><div class="line">    <span class="string">'host'</span> =&gt; <span class="string">'tcp://0.0.0.0:9527'</span>,</div><div class="line">    <span class="string">'class'</span> =&gt; \FastD\Servitization\Server\TCPServer::class,</div><div class="line">    <span class="string">'options'</span> =&gt; [</div><div class="line">        <span class="string">'pid_file'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../runtime/pid/'</span> . app()-&gt;getName() . <span class="string">'.pid'</span>,</div><div class="line">        <span class="string">'worker_num'</span> =&gt; <span class="number">10</span>,</div><div class="line">        <span class="string">'task_worker_num'</span> =&gt; <span class="number">20</span>,</div><div class="line">    ],</div><div class="line">    <span class="string">'listeners'</span> =&gt; [</div><div class="line">        [</div><div class="line">            <span class="string">'class'</span> =&gt; \FastD\Servitization\Server\MonitorStatusServer::class,</div><div class="line">            <span class="string">'host'</span> =&gt; <span class="string">'tcp://127.0.0.1:9529'</span>,</div><div class="line">        ],</div><div class="line">    ],</div><div class="line">];</div></pre></td></tr></table></figure>
<p>通过命令: <code>php bin/console tcp://127.0.0.1:9529</code> </p>
<p>连接成功后，进入交互界面:</p>
<p>通过访问具体路由，验证具体方法是否可行，或者可以进行测试，更多的想象，更多的功能，更多的实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Continue with this action [get /hello foo:bar] ? get /</div><div class="line">&#123;</div><div class="line">    &quot;foo&quot;: &quot;bar&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还可以通过监控管理服务，支持部分命令: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">status</div><div class="line">reload</div><div class="line">shutdown</div><div class="line">...</div></pre></td></tr></table></figure>
<p>更多命令支持，敬请期待。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="黄总" />
          <p class="site-author-name" itemprop="name">黄总</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">黄总</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"janhuang"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


  

</body>
</html>
